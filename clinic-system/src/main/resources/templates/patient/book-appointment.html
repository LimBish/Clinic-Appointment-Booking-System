<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/layout :: head('Book Appointment')}"></head>
<body class="bg-light d-flex flex-column" style="min-height:100vh">

<div th:replace="~{fragments/layout :: navbar}"></div>
<div th:replace="~{fragments/layout :: alerts}"></div>

<main class="container my-4 flex-grow-1">

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0 text-primary"><i class="bi bi-calendar-plus me-2"></i>Book New Appointment</h5>
                </div>
                <div class="card-body p-4">

                    <!-- ── Step 1: Select Doctor & Date ── -->
                    <form th:action="@{/patient/appointments/book}" method="get" class="row g-3 mb-4 border-bottom pb-4">
                        <div class="col-md-5">
                            <label class="form-label fw-semibold">1. Choose Doctor</label>
                            <select name="doctorId" class="form-select">
                                <option value="">-- Select Doctor --</option>
                                <option th:each="doc : ${doctors}"
                                        th:value="${doc.id}"
                                        th:text="'Dr. ' + ${doc.user.fullName} + ' (' + ${doc.specialization} + ')'"
                                        th:selected="${selectedDoctor != null and selectedDoctor.id == doc.id}"></option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label fw-semibold">2. Select Date</label>
                            <input type="date" name="date" class="form-select"
                                   th:value="${selectedDate}"
                                   th:min="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}"/>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-outline-secondary w-100">Check</button>
                        </div>
                    </form>

                    <!-- ── Step 2: Choose Slot & Reason ── -->
                    <form th:if="${availableSlots != null}" th:action="@{/patient/appointments/book}"
                          th:object="${bookRequest}" method="post">

<!--                        <input type="hidden" th:field="*{doctorId}" />-->
<!--                        <input type="hidden" th:field="*{appointmentDate}" />-->



                        <div class="mb-4">
                            <label class="form-label fw-semibold d-block mb-3">3. Pick an Available Slot</label>
                            <div class="row g-2">
                                <div th:each="slot : ${availableSlots}" class="col-md-3 col-sm-4">
                                    <input type="radio" class="btn-check" th:field="*{appointmentTime}"
                                           th:value="${slot.time}" th:id="'slot_' + ${slotStat.index}"
                                           th:disabled="${!slot.available}"/>
                                    <label class="btn btn-outline-primary w-100" th:for="'slot_' + ${slotStat.index}"
                                           th:text="${#temporals.format(slot.time, 'hh:mm a')}"></label>

                                </div>
                                <div th:if="${#lists.isEmpty(availableSlots)}" class="col-12 text-center py-3 text-danger">
                                    <i class="bi bi-calendar-x me-2"></i>No slots available for this date.
                                </div>
                            </div>
                            <div th:if="${#fields.hasErrors('appointmentTime')}" class="text-danger small mt-1"
                                 th:errors="*{appointmentTime}"></div>
                        </div>
<!--                        <input type="hidden" th:field="*{doctorId}" th:value="${selectedDoctor.id}"/>-->
<!--                        <input type="hidden" th:field="*{appointmentDate}" th:value="${selectedDate}"/>-->

                        <input type="hidden" name="doctorId" th:value="${selectedDoctor.id}" />
                        <input type="hidden" name="appointmentDate" th:value="${selectedDate}" />
                        <div class="mb-4">
                            <label class="form-label fw-semibold">4. Reason for Visit</label>
                            <textarea th:field="*{reason}" class="form-control" rows="3"
                                      placeholder="Briefly describe your symptoms or reason for visit..."></textarea>
                            <div th:if="${#fields.hasErrors('reason')}" class="text-danger small mt-1"
                                 th:errors="*{reason}"></div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg"
                                    th:disabled="${#lists.isEmpty(availableSlots)}">
                                Confirm Booking
                            </button>
                        </div>
                    </form>
                    
                    <div th:if="${availableSlots == null}" class="text-center py-5 text-muted">
                        <i class="bi bi-info-circle display-4 mb-2"></i>
                        <p>Select a doctor and date to see available time slots.</p>
                    </div>

                </div>
            </div>
        </div>
    </div>

</main>

<div th:replace="~{fragments/layout :: footer}"></div>
<div th:replace="~{fragments/layout :: scripts}"></div>
</body>
</html>
